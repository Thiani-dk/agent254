{% extends "base.html" %}
{% block content %}
<div class="form-container">
  <h2>Message Encrypted &amp; OTP "Sent" (DEV)</h2>

  <p>Your Message ID: <strong>{{ message_id }}</strong></p>
  <p><strong>[DEV] OTP:</strong> <code>{{ otp_code }}</code></p>

  {# Precompute a zero-padded “MM:SS” for the initial display #}
  {% set mins = expiry_seconds // 60 %}
  {% set secs = expiry_seconds % 60 %}
  {% set initial_minutes = mins %}
  {% set initial_seconds = ("%02d"|format(secs)) %}

  <p>OTP Expires In:
    <span id="countdown">{{ initial_minutes }}:{{ initial_seconds }}</span>
  </p>

  <div class="form-group">
    <textarea class="ciphertext-box" readonly>{{ message_id }}</textarea>
    <button class="copy-btn" onclick="copyToClipboard('{{ message_id }}')">
      Copy Message ID
    </button>
  </div>

  <p>Share the Message ID and OTP with the recipient so they can decrypt.</p>
</div>

<script>
// ─────────────────────────────────────────────────────────────────────────────
// Live Countdown Timer (MM:SS). When it hits zero, display “OTP Expired” in red.
// ─────────────────────────────────────────────────────────────────────────────
(function() {
  // Read the integer `expiry_seconds` injected by Jinja:
  let remaining = {{ expiry_seconds }};
  const countdownElem = document.getElementById("countdown");

  // Helper: format seconds as “M:SS” (zero-pad seconds)
  function formatTime(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return m + ":" + (s < 10 ? "0" + s : s);
  }

  function tick() {
    if (remaining <= 0) {
      countdownElem.textContent = "OTP Expired";
      countdownElem.style.color = "#E10600";  // red
      return;
    }
    countdownElem.textContent = formatTime(remaining);
    remaining--;
    setTimeout(tick, 1000);
  }

  // Start ticking once the DOM is loaded
  window.addEventListener("DOMContentLoaded", function() {
    tick();
  });
})();
</script>
{% endblock %}
